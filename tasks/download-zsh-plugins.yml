---
- name: download zsh-plugins
  tags:
    # Suppress warning: [ANSIBLE0006] git used in place of git module
    # Git module doesn't allow us to set `core.autocrlf=input`.
    - skip_ansible_lint
  become: "yes"
  become_user: '{{ username }}'
  command: >-
    git clone -c core.autocrlf=input --depth=1  -b {{ item[0].version }}
     https://github.com/{{ item[0].url }}.git ~{{ item[1] }}/.cache/antibody/https-COLON--SLASH--SLASH-github.com-SLASH-{{ zsh_theme }}-SLASH-oh-my-zsh/plugins/{{ item[0].url }}
  # core.autocrlf=input prevents
  # https://github.com/robbyrussell/oh-my-zsh/issues/4402
  args:
    chdir: "~{{ item[1] }}/.cache/antibody/https-COLON--SLASH--SLASH-github.com-SLASH-{{ zsh_theme }}-SLASH-oh-my-zsh/plugins/"
    creates: '~{{ item[1] }}/.cache/antibody/https-COLON--SLASH--SLASH-github.com-SLASH-{{ zsh_theme }}-SLASH-oh-my-zsh/plugins/{{ item[0].url }}'
  with_nested:
    - "{{ antibody_bundles | map(attribute='repo') | select('defined') | list }}"
    - "{{ users | map(attribute='username') | select('defined') | list }}"
    # https://medium.com/opsops/filtering-away-an-undefined-value-from-a-list-in-ansible-867ff4574b60
